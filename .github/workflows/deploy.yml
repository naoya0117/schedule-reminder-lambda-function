name: Deploy Schedule Reminder

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production
    permissions: 
      id-token: write
      contents: read
    env:
      OIDC_ROLE: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ScheduleReminderGitHubDeployRole
      SAM_CONFIG_ENV: prod
      AWS_REGION: ap-northeast-1
      PARAM_PATH_PREFIX: /lambda-functions/schedule-reminder
      SAM_CLI_TELEMETRY: 0
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: src/app/go.sum
      
      - name: Setup SAM
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.OIDC_ROLE }}
      
      - name: Verify AWS credentials
        run: aws sts get-caller-identity
        
      - name: Build SAM application
        run: |
          cd ./src
          sam build --config-env ${{ env.SAM_CONFIG_ENV }}
        
      - name: Deploy SAM application
        run: |
          cd ./src
          sam deploy --config-env ${{ env.SAM_CONFIG_ENV }}
      
      - name: Store parameters in Parameter Store
        run: |
          for param in "param-notion-api-key:${{ secrets.PARAM_NOTION_API_KEY }}:SecureString" "param-reminder-config-db-id:${{ secrets.PARAM_REMINDER_CONFIG_DB_ID }}:String"; do
            IFS=':' read -r name value type <<< "$param"
            
            # まず更新を試行し、失敗したら新規作成（タグ付き）
            aws ssm put-parameter \
              --region "${{ env.AWS_REGION }}" \
              --name "${{ env.PARAM_PATH_PREFIX }}/$name" \
              --value "$value" \
              --type "$type" \
              --overwrite || \
            aws ssm put-parameter \
              --region "${{ env.AWS_REGION }}" \
              --name "${{ env.PARAM_PATH_PREFIX }}/$name" \
              --value "$value" \
              --type "$type" \
              --tags Key=Project,Value=schedule-reminder
          done
      
      - name: Output deployment info
        run: |
          echo "Deployment completed successfully!"
          aws cloudformation describe-stacks \
            --stack-name schedule-reminder \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table
