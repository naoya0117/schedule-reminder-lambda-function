on:
  # サンプルプロジェクトのため，トリガーを無効化
  #push:
  #  branches:
  #    - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production
    permissions: 
      id-token: write
      contents: read
    env:
      OIDC_ROLE: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/SampleProjectSamGitHubDeployRole
      SAM_CONFIG_ENV: prod
      AWS_REGION: us-east-1
      PARAM_PATH_PREFIX: /lambda-functions/sample-project
      SAM_CLI_TELEMETRY: 0
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Setup SAM
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.OIDC_ROLE }}
      
      - name: Verify AWS credentials
        run: aws sts get-caller-identity
        
      - name: Build SAM application
        run: |
          cd ./src
          sam build --config-env ${{ env.SAM_CONFIG_ENV }}
        
      - name: Deploy SAM application
        run: |
          cd ./src
          sam deploy --config-env ${{ env.SAM_CONFIG_ENV }}
      
      - name: Store parameters in Parameter Store
        run: |
          for param in "param-secret-key:${{ secrets.PARAM_SECRET_KEY }}:SecureString"; do
            IFS=':' read -r name value type <<< "$param"
            
            # まず更新を試行し、失敗したら新規作成（タグ付き）
            aws ssm put-parameter \
              --region "${{ env.AWS_REGION }}" \
              --name "${{ env.PARAM_PATH_PREFIX }}/$name" \
              --value "$value" \
              --type "$type" \
              --overwrite || \
            aws ssm put-parameter \
              --region "${{ env.AWS_REGION }}" \
              --name "${{ env.PARAM_PATH_PREFIX }}/$name" \
              --value "$value" \
              --type "$type" \
              --tags Key=Project,Value=sampleProject
          done
              
